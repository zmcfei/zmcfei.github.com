<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="author" content="海涛" />
    <title>Mac&iOS Socket | 海涛</title>
    <link href="data:image/x-icon;base64,AAABAAEAEBAQAAAAAAAoAQAAFgAAACgAAAAQAAAAIAAAAAEABAAAAAAAgAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAD/APr59wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIiIiIiIiAAAiIiIiIiIAACIiIiIiIgERERERERIiAREREREREiIBERERERESIgERIiIiERIiAREiIiIREiIBESIhERESIgERIiERERIiAREiIiIiIiIBESIiIiIiIgERIiIiIiIiAREREREREAABEREREREQAAERERERERAADgAQAA4AEAAOABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAA8AAAAPAAAADwAA" rel="icon" type="image/x-icon" />
    <link href="/feed/" rel="alternate" title="海涛" type="application/atom+xml" />
    
    <link rel="stylesheet" href="/media/css/highlight.css">
    <link href='/media/webfonts/ss-social.css' rel='stylesheet'>
    <link href='/media/webfonts/ss-standard.css' rel='stylesheet'>
    <link href="/media/css/screen.css" rel="stylesheet">

    <script type="text/javascript" src="/media/js/jquery-1.7.1.min.js"></script>
  </head>
  <body>
    <div id="container">
      <div id="main" role="main">
        <header>
        <div class="buttons">
          <a href="/" class="ss-icon" title="Go to homepage">home</a>
          <a href="/categories" class="ss-icon" title="Category" >list</a>
          <a href="/tags" class="ss-icon" title="Tag Cloud" >tags</a>
          <a href="/guestbook" class="ss-icon" title="Guest Book" >talk</a>
          <a href="/about" class="ss-icon" title="About" >user</a>
          <a href="/feed" class="ss-icon" title="Subscribe by RSS" >rss</a>
        </div>
        <h1>Mac&iOS Socket</h1>
        </header>
        <hr>
        <article class="content">
        <section class="post">
<h3>大纲</h3>

<ul>
<li>一.Socket简介</li>
<li>二.BSD Socket编程准备

<ul>
<li>1.地址</li>
<li>2.端口</li>
<li>3.网络字节序</li>
<li>4.半相关与全相关</li>
<li>5.网络编程模型</li>
</ul>
</li>
<li>三.socket接口编程示例</li>
<li>四.使用select</li>
<li>五.使用kqueue</li>
<li>六.使用流</li>
</ul>


<blockquote><p>注:文档中设计涉及的代码也都在本人github目录下，分别为socketServer和socketClient.对应着各个分支。
<img src="http://farm6.staticflickr.com/5271/7078374971_632b0b2f71_d.jpg" alt="分支" /></p></blockquote>

<hr />

<h3>一.Socket简介</h3>

<p>在UNIX系统中,万物皆文件(Everything is a file)。所有的IO操作都可以看作对文件的IO操作，都遵循着这样的操作模式:打开 -> 读/写 -> 关闭，打开操作（如open函数）获取“文件”使用权，返回文件描述符，后继的操作都通过这个文件描述符来进行。很多系统调用都依赖于文件描述符,它是一个无符号整数，每一个用户进程都对应着一个文件描述符表，通过文件描述符就可以找到对应文件的信息。
在类UNIX平台上，对于控制台的标准输入输出以及标准错误输出都有对应的文件描述符，分别为0,1,2。它们定义在 <code>unistd.h</code>中</p>

<div class="highlight"><pre><code class="c"><span class="cp">#define     STDIN_FILENO   0   </span><span class="cm">/* standard input file descriptor */</span><span class="cp"></span>
<span class="cp">#define    STDOUT_FILENO   1   </span><span class="cm">/* standard output file descriptor */</span><span class="cp"></span>
<span class="cp">#define    STDERR_FILENO   2   </span><span class="cm">/* standard error file descriptor */</span><span class="cp">   </span>
</code></pre></div>


<p>在Mac系统中，可以通过Activity Monitor来查看某个进程打开的文件和端口。
<img src="http://farm6.staticflickr.com/5446/7078375235_2d4e64cb1c_z_d.jpg" alt="已打开文件" /></p>

<p>UNIX内核加入TCP/IP协议的时候，便在系统中引入了一种新的IO操作，只不过由于网络连接的不可靠性，所以网络IO比本地设备的IO复杂很多。这一系列的接口叫做BSD Socket API,当初由伯克利大学研发，最终成为网络开发接口的标准。
网络通信从本质上讲也是进程间通信，只是这两个进程一般在网络中不同计算机上。当然Socket API其实也提供了专门用于本地IPC的使用方式：UNIX Domain Socket，这个这里就不细说了。本文所讲的Socket如无例外，均是说的Internet Socket。</p>

<p>在本地的进程中，每一个进程都可以通过PID来标识，对于网络上的一个计算机中的进程如何标识呢？网络中的计算机可以通过一个IP地址进行标识，一个计算机中的某个进程则可以通过一个无符号整数（端口号）来标识，所以一个网络中的进程可以通过<code>IP地址+端口号</code>的方式进行标识。</p>

<h3>二.BSD Socket编程准备</h3>

<h4>1.地址</h4>

<p>在程序中，我们如何保存一个地址呢？在 <code>&lt;sys/socket.h&gt;</code>中的sockaddr便是描述socket地址的结构体类型.</p>

<div class="highlight"><pre><code class="c"><span class="cm">/*</span>
<span class="cm">* [XSI] Structure used by kernel to store most addresses.</span>
<span class="cm">*/</span>
<span class="k">struct</span> <span class="n">sockaddr</span> <span class="p">{</span>
    <span class="kt">__uint8_t</span>   <span class="n">sa_len</span><span class="p">;</span>       <span class="cm">/* total length */</span>
    <span class="kt">sa_family_t</span> <span class="n">sa_family</span><span class="p">;</span>    <span class="cm">/* [XSI] address family */</span>
    <span class="kt">char</span>        <span class="n">sa_data</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span>   <span class="cm">/* [XSI] addr value (actually larger) */</span>
<span class="p">};</span>
</code></pre></div>


<p>为了方便设置用语网络通信的socket地址，引入了sockaddr_in结构体（对于UNIX Domain Socket则对应sockaddr_un）</p>

<div class="highlight"><pre><code class="c"><span class="cm">/*</span>
<span class="cm"> * Socket address, internet style.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="p">{</span>
    <span class="kt">__uint8_t</span>   <span class="n">sin_len</span><span class="p">;</span>
    <span class="kt">sa_family_t</span> <span class="n">sin_family</span><span class="p">;</span>
    <span class="kt">in_port_t</span>   <span class="n">sin_port</span><span class="p">;</span><span class="c1">//得是网络字节序</span>
    <span class="k">struct</span>   <span class="n">in_addr</span> <span class="n">sin_addr</span><span class="p">;</span><span class="c1">//in_addr存在的原因则是历史原因，其实质是代表一个IP地址的32位整数</span>
    <span class="kt">char</span>        <span class="n">sin_zero</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span><span class="c1">//bzero之，纯粹是为了兼容sockaddr</span>
<span class="p">};</span>
</code></pre></div>


<p>在实际编程的时候，经常需要将sockaddr_in强制转换成sockaddr类型。</p>

<h4>2.端口</h4>

<p>说到端口我们经常会联想到硬件，在网络编程中的端口其实是一个标识而已，或者说是系统的资源而已。系统提供了端口分配和管理的机制。</p>

<h4>3.网络字节序</h4>

<p>谈网络字节序(Endianness)之前我们先说说什么是字节序。字节序又叫端序，就是指计算机中存放 <strong>多字节数据</strong>的字节的顺序。典型的就是数据存放在内存中或者网络传输时的字节的顺序。常用的字节序有大端序(big-endian)，小端序(litle-endian,另还有不常见的混合序middle-endian)。不同的CPU可能会使用不同的字节序，如X86，PDP-11等处理器为小端序，Motorola 6800,PowerPC 970等使用的是大端序。小端序是指低字节位存放在内存地址的低端，高端序是指高位字节存放在内存的低端。
举个例子来说明什么是大端序和小端序：
比如一个4字节的整数 16进制形式为 0x12345678，最左边是高位。</p>

<p>大端序</p>

<table>
<tr><td>低位</td><td>    </td><td>    </td><td>高位</td></tr>
<tr><td>12</td><td>34</td><td>56</td><td>78</td></tr>
</table>


<p> 小端序</p>

<table>
<tr><td>低位</td><td>    </td><td>    </td><td>高位</td></tr>
<tr><td>78</td><td>56</td><td>34</td><td>12</td></tr>
</table>


<p>TCP/IP 各层协议将字节序使用的是大端序，我们把TCP/IP协议中使用的字节序称之为网络字节序。
 编程的时候可以使用定义在<code>sys/_endian.h</code>中的相关的接口进行本地字节序和网络字节序的互转。</p>

<div class="highlight"><pre><code class="c"><span class="cp">#define ntohs(x)   __DARWIN_OSSwapInt16(x) </span><span class="c1">// 16位整数 网络字节序转主机字节序</span>
<span class="cp">#define htons(x)   __DARWIN_OSSwapInt16(x) </span><span class="c1">// 16位整数 主机字节序转网络字节序</span>

<span class="cp">#define ntohl(x)   __DARWIN_OSSwapInt32(x)  </span><span class="c1">//32位整数 网络字节序转主机字节序</span>
<span class="cp">#define htonl(x)   __DARWIN_OSSwapInt32(x) </span><span class="c1">//32位整数 主机字节序转网络字节序</span>
</code></pre></div>


<blockquote><p>以上声明中 n代表netwrok， h代表host ，s代表short，l代表long</p></blockquote>

<p>如果数据是单字节的话，则其没有字节序的说法了。</p>

<h4>4.半相关与全相关</h4>

<p>半相关（half-association）是指一个三元组 <code>(协议,本地IP地址,本地端口)</code>,通过这个三元组就可以唯一标识一个网络中的进程,一般用于listening socket。但是实际进行通信的过程，至少需要两个进程，且它们所使用的协议必须一致，所以一个完成的网络通信至少需要一个五元组表示<code>(协议,本地地址,本地端口,远端地址,远端端口)</code>，这样的五元组叫做全相关。</p>

<h4>5.网络编程模型</h4>

<p>网络存在的本质其实就是网络中个体之间的在某个领域的信息存在不对等性，所以一般情况下总有一些个体为另一些个体提供服务。提供服务器的我们把它叫做服务器，接受服务的叫做客户端。所以在网络编程中，也存在服务器端和客户端之分。</p>

<table>
<tr>
<td>服务器端</td><td>客户端</td>
<tr>
<td>创建Socket</td><td>-</td>
</tr>
<tr>
<td>将Socket和本地的地址端口绑定</td><td>-</td>
</tr>
<tr>
<td>开始进行侦听</td><td>创建一个Socket和服务器的地址并通过它们向服务器发送连接请求</td>
</tr>
<tr>
<td>握手成功，接受请求，得到一个新的Socket，通过它可以和客户端进行通信</td><td>连接成功，客户端的Socket会绑定到系统分配的一个端口上，并可以通过它和服务器端进行通信</td>
</tr>
</table>


<h3>三.BSD Socket编程详解</h3>

<p>下面的例子是一个简单的一对一聊天的程序，分服务器和客户端，且发送消息和接受消息次序固定。</p>

<h4>Server端代码</h4>

<div class="highlight"><pre><code class="c"><span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;netinet/in.h&gt;</span>
<span class="cp">#include &lt;sys/socket.h&gt;</span>
<span class="cp">#include &lt;arpa/inet.h&gt;</span>
<span class="cp">#include &lt;string.h&gt;</span>

<span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">server_addr</span><span class="p">;</span>
    <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span><span class="p">);</span>
    <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span><span class="c1">//Address families AF_INET互联网地址簇</span>
    <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">11332</span><span class="p">);</span>
    <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">inet_addr</span><span class="p">(</span><span class="s">&quot;127.0.0.1&quot;</span><span class="p">);</span>
    <span class="n">bzero</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">server_addr</span><span class="p">.</span><span class="n">sin_zero</span><span class="p">),</span><span class="mi">8</span><span class="p">);</span>
    
    <span class="c1">//创建socket</span>
    <span class="kt">int</span> <span class="n">server_socket</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span><span class="c1">//SOCK_STREAM 有连接</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">server_socket</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&quot;socket error&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="c1">//绑定socket：将创建的socket绑定到本地的IP地址和端口，此socket是半相关的，只是负责侦听客户端的连接请求，并不能用于和客户端通信</span>
    <span class="kt">int</span> <span class="n">bind_result</span> <span class="o">=</span> <span class="n">bind</span><span class="p">(</span><span class="n">server_socket</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">server_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server_addr</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">bind_result</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&quot;bind error&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="c1">//listen侦听 第一个参数是套接字，第二个参数为等待接受的连接的队列的大小，在connect请求过来的时候,完成三次握手后先将连接放到这个队列中，直到被accept处理。如果这个队列满了，且有新的连接的时候，对方可能会收到出错信息。</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">listen</span><span class="p">(</span><span class="n">server_socket</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&quot;listen error&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">client_address</span><span class="p">;</span>
    <span class="kt">socklen_t</span> <span class="n">address_len</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">client_socket</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">server_socket</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">client_address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">address_len</span><span class="p">);</span>
    <span class="c1">//返回的client_socket为一个全相关的socket，其中包含client的地址和端口信息，通过client_socket可以和客户端进行通信。</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">client_socket</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&quot;accept error&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="kt">char</span> <span class="n">recv_msg</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">reply_msg</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
    
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">bzero</span><span class="p">(</span><span class="n">recv_msg</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span>
        <span class="n">bzero</span><span class="p">(</span><span class="n">reply_msg</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span>
        
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;reply:&quot;</span><span class="p">);</span>
        <span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span><span class="n">reply_msg</span><span class="p">);</span>
        <span class="n">send</span><span class="p">(</span><span class="n">client_socket</span><span class="p">,</span> <span class="n">reply_msg</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        
        <span class="kt">long</span> <span class="n">byte_num</span> <span class="o">=</span> <span class="n">recv</span><span class="p">(</span><span class="n">client_socket</span><span class="p">,</span><span class="n">recv_msg</span><span class="p">,</span><span class="mi">1024</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
        <span class="n">recv_msg</span><span class="p">[</span><span class="n">byte_num</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;client said:%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">recv_msg</span><span class="p">);</span>

    <span class="p">}</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>


<h4>Client端代码</h4>

<div class="highlight"><pre><code class="c"><span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;netinet/in.h&gt;</span>
<span class="cp">#include &lt;sys/socket.h&gt;</span>
<span class="cp">#include &lt;arpa/inet.h&gt;</span>
<span class="cp">#include &lt;string.h&gt;</span>

<span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">server_addr</span><span class="p">;</span>
    <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span><span class="p">);</span>
    <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">11332</span><span class="p">);</span>
    <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">inet_addr</span><span class="p">(</span><span class="s">&quot;127.0.0.1&quot;</span><span class="p">);</span>
    <span class="n">bzero</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">server_addr</span><span class="p">.</span><span class="n">sin_zero</span><span class="p">),</span><span class="mi">8</span><span class="p">);</span>
    
    <span class="kt">int</span> <span class="n">server_socket</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">server_socket</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&quot;socket error&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">char</span> <span class="n">recv_msg</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">reply_msg</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">connect</span><span class="p">(</span><span class="n">server_socket</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">server_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span><span class="p">))</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>  <span class="p">{</span>
    <span class="c1">//connect 成功之后，其实系统将你创建的socket绑定到一个系统分配的端口上，且其为全相关，包含服务器端的信息，可以用来和服务器端进行通信。</span>
        <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">bzero</span><span class="p">(</span><span class="n">recv_msg</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span>
            <span class="n">bzero</span><span class="p">(</span><span class="n">reply_msg</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span>
            <span class="kt">long</span> <span class="n">byte_num</span> <span class="o">=</span> <span class="n">recv</span><span class="p">(</span><span class="n">server_socket</span><span class="p">,</span><span class="n">recv_msg</span><span class="p">,</span><span class="mi">1024</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
            <span class="n">recv_msg</span><span class="p">[</span><span class="n">byte_num</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;server said:%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">recv_msg</span><span class="p">);</span>
            
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;reply:&quot;</span><span class="p">);</span>
            <span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span><span class="n">reply_msg</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">send</span><span class="p">(</span><span class="n">server_socket</span><span class="p">,</span> <span class="n">reply_msg</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">perror</span><span class="p">(</span><span class="s">&quot;send error&quot;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
    <span class="p">}</span>
    
    <span class="c1">// insert code here...</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Hello, World!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>


<p>上面的服务器端和客户端连接成功之后打开的端口的情况是怎么样的呢？</p>

<ul>
<li><p>服务器端 ,存在一个用于listen的半相关的socket，一个用于和客户端进行通信的全相关的socket
<img src="http://farm8.staticflickr.com/7279/7078375445_082672001e_z_d.jpg" alt="服务器端进程打开文件" /></p></li>
<li><p>客户端 存在一个用于和服务器端进行通信的全相关的socket
<img src="http://farm8.staticflickr.com/7242/6932301638_10cf5ab8b8_z_d.jpg" alt="客户端进程打开文件" /></p></li>
</ul>


<p>由于accept只运行了一次，所以服务器端一次只能和一个客户端进行通信，且使用的send和recv方法都是阻塞的，所以上面这个例子存在一个问题就是服务器端客户端连接成功之后，发送，接受，发送，接受的次序就被固定了。比如服务器端发送消息之后就等客户端发送消息了，没有接受到客户端的消息之前服务器端是没有办法发送消息的。使用select这个这个系统调用可以解决上面的问题。</p>

<h3>四.使用select</h3>

<p> select这个系统调用，是一种多路复用IO方案，可以同时对多个文件描述符进行监控，从而知道哪些文件描述符可读，可写或者出错，不过select方法是阻塞的，可以设定超时时间。
 select使用的步骤如下:</p>

<ul>
<li>1.创建一个fd_set变量（fd_set实为包含了一个整数数组的结构体），用来存放所有的待检查的文件描述符</li>
<li>2.清空fd_set变量，并将需要检查的所有文件描述符加入fd_set</li>
<li>3.调用select。若返回-1，则说明出错;返回0,则说明超时，返回正数，则为发生状态变化的文件描述符的个数</li>
<li>4.若select返回大于0,则依次查看哪些文件描述符变的可读，并对它们进行处理</li>
<li>5.返回步骤2，开始新一轮的检测</li>
</ul>


<p>若上面的聊天程序使用select进行改写，则是下面这样的</p>

<h4>服务器端</h4>

<div class="highlight"><pre><code class="c"><span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="cp">#include &lt;netinet/in.h&gt;</span>
<span class="cp">#include &lt;sys/socket.h&gt;</span>
<span class="cp">#include &lt;arpa/inet.h&gt;</span>
<span class="cp">#include &lt;string.h&gt;</span>
<span class="cp">#include &lt;unistd.h&gt;</span>
<span class="cp">#define BACKLOG 5 </span><span class="c1">//完成三次握手但没有accept的队列的长度</span>
<span class="cp">#define CONCURRENT_MAX 8 </span><span class="c1">//应用层同时可以处理的连接</span>
<span class="cp">#define SERVER_PORT 11332</span>
<span class="cp">#define BUFFER_SIZE 1024</span>
<span class="cp">#define QUIT_CMD &quot;.quit&quot;</span>
<span class="kt">int</span> <span class="n">client_fds</span><span class="p">[</span><span class="n">CONCURRENT_MAX</span><span class="p">];</span>
<span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">input_msg</span><span class="p">[</span><span class="n">BUFFER_SIZE</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">recv_msg</span><span class="p">[</span><span class="n">BUFFER_SIZE</span><span class="p">];</span>   
    <span class="c1">//本地地址</span>
    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">server_addr</span><span class="p">;</span>
    <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span><span class="p">);</span>
    <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">SERVER_PORT</span><span class="p">);</span>
    <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">inet_addr</span><span class="p">(</span><span class="s">&quot;127.0.0.1&quot;</span><span class="p">);</span>
    <span class="n">bzero</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">server_addr</span><span class="p">.</span><span class="n">sin_zero</span><span class="p">),</span><span class="mi">8</span><span class="p">);</span>
    <span class="c1">//创建socket</span>
    <span class="kt">int</span> <span class="n">server_sock_fd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">server_sock_fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&quot;socket error&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">//绑定socket</span>
    <span class="kt">int</span> <span class="n">bind_result</span> <span class="o">=</span> <span class="n">bind</span><span class="p">(</span><span class="n">server_sock_fd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">server_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server_addr</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">bind_result</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&quot;bind error&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">//listen</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">listen</span><span class="p">(</span><span class="n">server_sock_fd</span><span class="p">,</span> <span class="n">BACKLOG</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&quot;listen error&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">//fd_set</span>
    <span class="n">fd_set</span> <span class="n">server_fd_set</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">max_fd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">timeval</span> <span class="n">tv</span><span class="p">;</span>
    <span class="n">tv</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
    <span class="n">tv</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">FD_ZERO</span><span class="p">(</span><span class="o">&amp;</span><span class="n">server_fd_set</span><span class="p">);</span>
        <span class="c1">//标准输入</span>
        <span class="n">FD_SET</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">server_fd_set</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">max_fd</span> <span class="o">&lt;</span> <span class="n">STDIN_FILENO</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">max_fd</span> <span class="o">=</span> <span class="n">STDIN_FILENO</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="c1">//服务器端socket</span>
        <span class="n">FD_SET</span><span class="p">(</span><span class="n">server_sock_fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">server_fd_set</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">max_fd</span> <span class="o">&lt;</span> <span class="n">server_sock_fd</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">max_fd</span> <span class="o">=</span> <span class="n">server_sock_fd</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="c1">//客户端连接</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CONCURRENT_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">client_fds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">FD_SET</span><span class="p">(</span><span class="n">client_fds</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">server_fd_set</span><span class="p">);</span>
                
                <span class="k">if</span> <span class="p">(</span><span class="n">max_fd</span> <span class="o">&lt;</span> <span class="n">client_fds</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
                    <span class="n">max_fd</span> <span class="o">=</span> <span class="n">client_fds</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">max_fd</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">server_fd_set</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tv</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">perror</span><span class="p">(</span><span class="s">&quot;select 出错</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;select 超时</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="c1">//ret为未状态发生变化的文件描述符的个数</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">FD_ISSET</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">server_fd_set</span><span class="p">))</span> <span class="p">{</span>
                <span class="c1">//标准输入</span>
                <span class="n">bzero</span><span class="p">(</span><span class="n">input_msg</span><span class="p">,</span> <span class="n">BUFFER_SIZE</span><span class="p">);</span>
                <span class="n">fgets</span><span class="p">(</span><span class="n">input_msg</span><span class="p">,</span> <span class="n">BUFFER_SIZE</span><span class="p">,</span> <span class="n">stdin</span><span class="p">);</span>
                <span class="c1">//输入 &quot;.quit&quot; 则退出服务器</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">input_msg</span><span class="p">,</span> <span class="n">QUIT_CMD</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">CONCURRENT_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">client_fds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">send</span><span class="p">(</span><span class="n">client_fds</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">input_msg</span><span class="p">,</span> <span class="n">BUFFER_SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">FD_ISSET</span><span class="p">(</span><span class="n">server_sock_fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">server_fd_set</span><span class="p">))</span> <span class="p">{</span>
                <span class="c1">//有新的连接请求</span>
                <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">client_address</span><span class="p">;</span>
                <span class="kt">socklen_t</span> <span class="n">address_len</span><span class="p">;</span>
                <span class="kt">int</span> <span class="n">client_socket_fd</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">server_sock_fd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">client_address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">address_len</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">client_socket_fd</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
                    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CONCURRENT_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">client_fds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
                            <span class="n">client_fds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">client_socket_fd</span><span class="p">;</span>
                            <span class="k">break</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;新客户端(%d)加入成功 %s:%d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">index</span><span class="p">,</span><span class="n">inet_ntoa</span><span class="p">(</span><span class="n">client_address</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">),</span><span class="n">ntohs</span><span class="p">(</span><span class="n">client_address</span><span class="p">.</span><span class="n">sin_port</span><span class="p">));</span>
                    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                        <span class="n">bzero</span><span class="p">(</span><span class="n">input_msg</span><span class="p">,</span> <span class="n">BUFFER_SIZE</span><span class="p">);</span>
                        <span class="n">strcpy</span><span class="p">(</span><span class="n">input_msg</span><span class="p">,</span> <span class="s">&quot;服务器加入的客户端数达到最大值,无法加入!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                        <span class="n">send</span><span class="p">(</span><span class="n">client_socket_fd</span><span class="p">,</span> <span class="n">input_msg</span><span class="p">,</span> <span class="n">BUFFER_SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
                        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;客户端连接数达到最大值，新客户端加入失败 %s:%d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">inet_ntoa</span><span class="p">(</span><span class="n">client_address</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">),</span><span class="n">ntohs</span><span class="p">(</span><span class="n">client_address</span><span class="p">.</span><span class="n">sin_port</span><span class="p">));</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">CONCURRENT_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">client_fds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">FD_ISSET</span><span class="p">(</span><span class="n">client_fds</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">server_fd_set</span><span class="p">))</span> <span class="p">{</span>
                        <span class="c1">//处理某个客户端过来的消息</span>
                        <span class="n">bzero</span><span class="p">(</span><span class="n">recv_msg</span><span class="p">,</span> <span class="n">BUFFER_SIZE</span><span class="p">);</span>
                        <span class="kt">long</span> <span class="n">byte_num</span> <span class="o">=</span> <span class="n">recv</span><span class="p">(</span><span class="n">client_fds</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">recv_msg</span><span class="p">,</span><span class="n">BUFFER_SIZE</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">byte_num</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">byte_num</span> <span class="o">&gt;</span> <span class="n">BUFFER_SIZE</span><span class="p">)</span> <span class="p">{</span>
                                <span class="n">byte_num</span> <span class="o">=</span> <span class="n">BUFFER_SIZE</span><span class="p">;</span>
                            <span class="p">}</span>
                            <span class="n">recv_msg</span><span class="p">[</span><span class="n">byte_num</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
                            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;客户端(%d):%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">recv_msg</span><span class="p">);</span>
                        <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">byte_num</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
                            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;从客户端(%d)接受消息出错.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
                        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                            <span class="n">FD_CLR</span><span class="p">(</span><span class="n">client_fds</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">server_fd_set</span><span class="p">);</span>
                            <span class="n">client_fds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;客户端(%d)退出了</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>


<h4>客户端</h4>

<div class="highlight"><pre><code class="c"><span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;netinet/in.h&gt;</span>
<span class="cp">#include &lt;sys/socket.h&gt;</span>
<span class="cp">#include &lt;arpa/inet.h&gt;</span>
<span class="cp">#include &lt;string.h&gt;</span>
<span class="cp">#include &lt;unistd.h&gt;</span>
<span class="cp">#include &lt;stdlib.h&gt;</span>

<span class="cp">#define BUFFER_SIZE 1024</span>

<span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">server_addr</span><span class="p">;</span>
    <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span><span class="p">);</span>
    <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">11332</span><span class="p">);</span>
    <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">inet_addr</span><span class="p">(</span><span class="s">&quot;127.0.0.1&quot;</span><span class="p">);</span>
    <span class="n">bzero</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">server_addr</span><span class="p">.</span><span class="n">sin_zero</span><span class="p">),</span><span class="mi">8</span><span class="p">);</span>
    
    <span class="kt">int</span> <span class="n">server_sock_fd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">server_sock_fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&quot;socket error&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">char</span> <span class="n">recv_msg</span><span class="p">[</span><span class="n">BUFFER_SIZE</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">input_msg</span><span class="p">[</span><span class="n">BUFFER_SIZE</span><span class="p">];</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">connect</span><span class="p">(</span><span class="n">server_sock_fd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">server_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span><span class="p">))</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fd_set</span> <span class="n">client_fd_set</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">timeval</span> <span class="n">tv</span><span class="p">;</span>
        <span class="n">tv</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
        <span class="n">tv</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        
        <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">FD_ZERO</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client_fd_set</span><span class="p">);</span>
            <span class="n">FD_SET</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client_fd_set</span><span class="p">);</span>
            <span class="n">FD_SET</span><span class="p">(</span><span class="n">server_sock_fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client_fd_set</span><span class="p">);</span>
            
            <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">server_sock_fd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client_fd_set</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tv</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;select 出错!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ret</span> <span class="o">==</span><span class="mi">0</span><span class="p">){</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;select 超时!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">FD_ISSET</span><span class="p">(</span><span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client_fd_set</span><span class="p">))</span> <span class="p">{</span>
                    <span class="n">bzero</span><span class="p">(</span><span class="n">input_msg</span><span class="p">,</span> <span class="n">BUFFER_SIZE</span><span class="p">);</span>
                    <span class="n">fgets</span><span class="p">(</span><span class="n">input_msg</span><span class="p">,</span> <span class="n">BUFFER_SIZE</span><span class="p">,</span> <span class="n">stdin</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">send</span><span class="p">(</span><span class="n">server_sock_fd</span><span class="p">,</span> <span class="n">input_msg</span><span class="p">,</span> <span class="n">BUFFER_SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">perror</span><span class="p">(</span><span class="s">&quot;发送消息出错!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                
                <span class="k">if</span> <span class="p">(</span><span class="n">FD_ISSET</span><span class="p">(</span><span class="n">server_sock_fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client_fd_set</span><span class="p">))</span> <span class="p">{</span>
                    <span class="n">bzero</span><span class="p">(</span><span class="n">recv_msg</span><span class="p">,</span> <span class="n">BUFFER_SIZE</span><span class="p">);</span>
                    <span class="kt">long</span> <span class="n">byte_num</span> <span class="o">=</span> <span class="n">recv</span><span class="p">(</span><span class="n">server_sock_fd</span><span class="p">,</span><span class="n">recv_msg</span><span class="p">,</span><span class="n">BUFFER_SIZE</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">byte_num</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">byte_num</span> <span class="o">&gt;</span> <span class="n">BUFFER_SIZE</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">byte_num</span> <span class="o">=</span> <span class="n">BUFFER_SIZE</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="n">recv_msg</span><span class="p">[</span><span class="n">byte_num</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
                        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;服务器:%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">recv_msg</span><span class="p">);</span>
                    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">byte_num</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
                        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;接受消息出错!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;服务器端退出!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
                    <span class="p">}</span>

                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>


<p>当然select也有其局限性。当fd_set中的文件描述符较少，或者大都数文件描述符都比较活跃的时候，select的效率还是不错的。Mac系统中已经定义了fd_set 最大可以容纳的文件描述符的个数为1024</p>

<div class="highlight"><pre><code class="c">    <span class="c1">//sys/_structs.h</span>
    <span class="err">#</span><span class="n">define</span> <span class="n">__DARWIN_FD_SETSIZE</span>  <span class="mi">1024</span>
    <span class="c1">/////////////////////////////////////////////</span>
    <span class="c1">//Kernel.framework sys/select.h</span>
    <span class="err">#</span><span class="n">define</span> <span class="n">FD_SETSIZE</span>   <span class="n">__DARWIN_FD_SETSIZE</span>
</code></pre></div>


<p>每一次select 调用的时候，都涉及到user space和kernel space的内存拷贝，且会对fd_set中的所有文件描述符进行遍历，如果所有的文件描述符均不满足，且没有超时，则当前进程便开始睡眠，直到超时或者有文件描述符状态发生变化。当文件描述符数量较大的时候，将耗费大量的CPU时间。所以后来有新的方案出现了，如windows2000引入的IOCP，Linux Kernel 2.6中成熟的epoll，FreeBSD4.x引入的kqueue。</p>

<h3>五.使用kqueue</h3>

<p>Mac是基于BSD的内核，所使用的是kqueue（kernel event notification mechanism，详细内容可以Mac中 <code>man 2 kqueue</code>），kqueue比select先进的地方就在于使用事件触发的机制，且其调用无需每次对所有的文件描述符进行遍历，返回的时候只返回需要处理的事件，而不像select中需要自己去一个个通过FD_ISSET检查。 <br/>
kqueue默认的触发方式是level 水平触发，可以通过设置event的flag为<code>EV_CLEAR</code> 使得这个事件变为边沿触发,可能epoll的触发方式无法细化到单个event，需要查证。</p>

<p>kqueue中涉及两个系统调用，kqueue()和kevent()</p>

<ul>
<li>kqueue() 创建kernel级别的事件队列，并返回队列的文件描述符</li>
<li>kevent() 往事件队列中加入订阅事件，或者返回相关的事件数组</li>
</ul>


<p>kqueue使用的流程一般如下：</p>

<ul>
<li>创建kqueue</li>
<li>创建struct kevent变量（注意这里的kevent是结构体类型名），可以通过EV_SET这个宏提供的快捷方式进行创建</li>
<li>通过kevent系统调用将创建好的kevent结构体变量加入到kqueue队列中，完成对指定文件描述符的事件的订阅</li>
<li>通过kevent系统调用获取满足条件的事件队列，并对每一个事件进行处理</li>
</ul>


<div class="highlight"><pre><code class="c"><span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="cp">#include &lt;netinet/in.h&gt;</span>
<span class="cp">#include &lt;sys/socket.h&gt;</span>
<span class="cp">#include &lt;sys/event.h&gt;</span>
<span class="cp">#include &lt;sys/types.h&gt;</span>
<span class="cp">#include &lt;sys/time.h&gt;</span>
<span class="cp">#include &lt;arpa/inet.h&gt;</span>
<span class="cp">#include &lt;string.h&gt;</span>
<span class="cp">#include &lt;unistd.h&gt;</span>
<span class="cp">#define BACKLOG 5 </span><span class="c1">//完成三次握手但没有accept的队列的长度</span>
<span class="cp">#define CONCURRENT_MAX 8 </span><span class="c1">//应用层同时可以处理的连接</span>
<span class="cp">#define SERVER_PORT 11332</span>
<span class="cp">#define BUFFER_SIZE 1024</span>
<span class="cp">#define QUIT_CMD &quot;.quit&quot;</span>
<span class="kt">int</span> <span class="n">client_fds</span><span class="p">[</span><span class="n">CONCURRENT_MAX</span><span class="p">];</span>
<span class="k">struct</span> <span class="n">kevent</span> <span class="n">events</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span><span class="c1">//CONCURRENT_MAX + 2</span>
<span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">input_msg</span><span class="p">[</span><span class="n">BUFFER_SIZE</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">recv_msg</span><span class="p">[</span><span class="n">BUFFER_SIZE</span><span class="p">];</span>
    <span class="c1">//本地地址</span>
    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">server_addr</span><span class="p">;</span>
    <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span><span class="p">);</span>
    <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">SERVER_PORT</span><span class="p">);</span>
    <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">inet_addr</span><span class="p">(</span><span class="s">&quot;127.0.0.1&quot;</span><span class="p">);</span>
    <span class="n">bzero</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">server_addr</span><span class="p">.</span><span class="n">sin_zero</span><span class="p">),</span><span class="mi">8</span><span class="p">);</span>
    <span class="c1">//创建socket</span>
    <span class="kt">int</span> <span class="n">server_sock_fd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">server_sock_fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&quot;socket error&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">//绑定socket</span>
    <span class="kt">int</span> <span class="n">bind_result</span> <span class="o">=</span> <span class="n">bind</span><span class="p">(</span><span class="n">server_sock_fd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">server_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server_addr</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">bind_result</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&quot;bind error&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">//listen</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">listen</span><span class="p">(</span><span class="n">server_sock_fd</span><span class="p">,</span> <span class="n">BACKLOG</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&quot;listen error&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">struct</span> <span class="n">timespec</span> <span class="n">timeout</span> <span class="o">=</span> <span class="p">{</span><span class="mi">10</span><span class="p">,</span><span class="mi">0</span><span class="p">};</span>
    <span class="c1">//kqueue</span>
    <span class="kt">int</span> <span class="n">kq</span> <span class="o">=</span> <span class="n">kqueue</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">kq</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&quot;创建kqueue出错!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">struct</span> <span class="n">kevent</span> <span class="n">event_change</span><span class="p">;</span>
    <span class="n">EV_SET</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event_change</span><span class="p">,</span> <span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="n">EVFILT_READ</span><span class="p">,</span> <span class="n">EV_ADD</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">kevent</span><span class="p">(</span><span class="n">kq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event_change</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">EV_SET</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event_change</span><span class="p">,</span> <span class="n">server_sock_fd</span><span class="p">,</span> <span class="n">EVFILT_READ</span><span class="p">,</span> <span class="n">EV_ADD</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">kevent</span><span class="p">(</span><span class="n">kq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event_change</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">kevent</span><span class="p">(</span><span class="n">kq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timeout</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;kevent 出错!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;kenvent 超时!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="c1">//ret &gt; 0 返回事件放在events中</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ret</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">struct</span> <span class="n">kevent</span> <span class="n">current_event</span> <span class="o">=</span> <span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
                <span class="c1">//kevent中的ident就是文件描述符</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">current_event</span><span class="p">.</span><span class="n">ident</span> <span class="o">==</span> <span class="n">STDIN_FILENO</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c1">//标准输入</span>
                    <span class="n">bzero</span><span class="p">(</span><span class="n">input_msg</span><span class="p">,</span> <span class="n">BUFFER_SIZE</span><span class="p">);</span>
                    <span class="n">fgets</span><span class="p">(</span><span class="n">input_msg</span><span class="p">,</span> <span class="n">BUFFER_SIZE</span><span class="p">,</span> <span class="n">stdin</span><span class="p">);</span>
                    <span class="c1">//输入 &quot;.quit&quot; 则退出服务器</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">input_msg</span><span class="p">,</span> <span class="n">QUIT_CMD</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">CONCURRENT_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">client_fds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">send</span><span class="p">(</span><span class="n">client_fds</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">input_msg</span><span class="p">,</span> <span class="n">BUFFER_SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">current_event</span><span class="p">.</span><span class="n">ident</span> <span class="o">==</span> <span class="n">server_sock_fd</span><span class="p">){</span>
                    <span class="c1">//有新的连接请求</span>
                    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">client_address</span><span class="p">;</span>
                    <span class="kt">socklen_t</span> <span class="n">address_len</span><span class="p">;</span>
                    <span class="kt">int</span> <span class="n">client_socket_fd</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">server_sock_fd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">client_address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">address_len</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">client_socket_fd</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
                        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CONCURRENT_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">client_fds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                                <span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
                                <span class="n">client_fds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">client_socket_fd</span><span class="p">;</span>
                                <span class="k">break</span><span class="p">;</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">EV_SET</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event_change</span><span class="p">,</span> <span class="n">client_socket_fd</span><span class="p">,</span> <span class="n">EVFILT_READ</span><span class="p">,</span> <span class="n">EV_ADD</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
                            <span class="n">kevent</span><span class="p">(</span><span class="n">kq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event_change</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
                            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;新客户端(fd = %d)加入成功 %s:%d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">client_socket_fd</span><span class="p">,</span><span class="n">inet_ntoa</span><span class="p">(</span><span class="n">client_address</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">),</span><span class="n">ntohs</span><span class="p">(</span><span class="n">client_address</span><span class="p">.</span><span class="n">sin_port</span><span class="p">));</span>
                        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                            <span class="n">bzero</span><span class="p">(</span><span class="n">input_msg</span><span class="p">,</span> <span class="n">BUFFER_SIZE</span><span class="p">);</span>
                            <span class="n">strcpy</span><span class="p">(</span><span class="n">input_msg</span><span class="p">,</span> <span class="s">&quot;服务器加入的客户端数达到最大值,无法加入!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                            <span class="n">send</span><span class="p">(</span><span class="n">client_socket_fd</span><span class="p">,</span> <span class="n">input_msg</span><span class="p">,</span> <span class="n">BUFFER_SIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
                            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;客户端连接数达到最大值，新客户端加入失败 %s:%d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">inet_ntoa</span><span class="p">(</span><span class="n">client_address</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">),</span><span class="n">ntohs</span><span class="p">(</span><span class="n">client_address</span><span class="p">.</span><span class="n">sin_port</span><span class="p">));</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                    <span class="c1">//处理某个客户端过来的消息</span>
                    <span class="n">bzero</span><span class="p">(</span><span class="n">recv_msg</span><span class="p">,</span> <span class="n">BUFFER_SIZE</span><span class="p">);</span>
                    <span class="kt">long</span> <span class="n">byte_num</span> <span class="o">=</span> <span class="n">recv</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">current_event</span><span class="p">.</span><span class="n">ident</span><span class="p">,</span><span class="n">recv_msg</span><span class="p">,</span><span class="n">BUFFER_SIZE</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">byte_num</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">byte_num</span> <span class="o">&gt;</span> <span class="n">BUFFER_SIZE</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">byte_num</span> <span class="o">=</span> <span class="n">BUFFER_SIZE</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="n">recv_msg</span><span class="p">[</span><span class="n">byte_num</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
                        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;客户端(fd = %d):%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">current_event</span><span class="p">.</span><span class="n">ident</span><span class="p">,</span><span class="n">recv_msg</span><span class="p">);</span>
                    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">byte_num</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
                        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;从客户端(fd = %d)接受消息出错.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">current_event</span><span class="p">.</span><span class="n">ident</span><span class="p">);</span>
                    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                        <span class="n">EV_SET</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event_change</span><span class="p">,</span> <span class="n">current_event</span><span class="p">.</span><span class="n">ident</span><span class="p">,</span> <span class="n">EVFILT_READ</span><span class="p">,</span> <span class="n">EV_DELETE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
                        <span class="n">kevent</span><span class="p">(</span><span class="n">kq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event_change</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
                        <span class="n">close</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">current_event</span><span class="p">.</span><span class="n">ident</span><span class="p">);</span>
                        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CONCURRENT_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">client_fds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">current_event</span><span class="p">.</span><span class="n">ident</span><span class="p">)</span> <span class="p">{</span>
                                <span class="n">client_fds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                                <span class="k">break</span><span class="p">;</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;客户端(fd = %d)退出了</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">current_event</span><span class="p">.</span><span class="n">ident</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>


<p>其实kqueue的应用场景非常的广阔，可以监控文件系统中文件的变化（对文件变化的事件可以粒度非常的细，具体可以查看kqueue的手册），监控系统进程的生命周期。GCD的事件处理便是建立在kqueue之上的。</p>

<h3>六.使用Streams</h3>

<p>使用Objective-C的一大优点便是面向对象编程，使得逻辑抽象得更加优美，更加符合人类思维。
一开始说过，无论是对于文件的操作或者对于网络的操作，本质上都是IO操作，无非写数据和读数据，可以对这种输入输出进行抽象，抽象成输入流和输出流， <strong>从输入流中读取数据，往输出流中写数据</strong>。
Cocoa中的NSInputStream和NSOutputStream便是输入流和输出流的抽象，它们的实现分别基于CoreFoundation中的CFReadStream和CFWriteStream。
输入输出流对runloop有很好的支持。
NSInputStream和CFReadStream以及NSOutputStream和CFWriteStream之间可以通过 "toll-free bridging"实现无缝的类型转换。
CoreFoundation中的CFStream提供了输入输出流和CFSocket绑定的函数。
这样便可以通过输入输出流和远端进行通信了。</p>

<p>首先通过XCode创建一个Foundation(C的也行，但是你得将<code>main.c</code> 改成<code>main.m</code>)的命令行项目.
创建一个ChatServer的类，包含一个run的方法。在Cocoa的程序中有一点是和C语言不同的，你无需自己去写一个死循环充当runloop，框架本身就对runloop进行了支持，需要做的就是将事件源加入到当前线程的runloop中，然后启动runloop。
所以在run方法中，创建好用于侦听连接请求的socket，socket有对应的处理连接accept的回调函数，以及把它封装成runloop的输入源，加入到当前runloop。
我们还得从标准输入获取需要发送消息，所以使用了CFFileDescriptor，它是文件描述符的objc的封装，加入了runloop的支持，通过它可以将标准输入以输入源的方法加入到当前runloop，当标准输入缓冲区有数据可读的时候，设置好的回调函数便会被调用。
最后启动runloop。</p>

<p><strong>ChatServer中的run方法</strong></p>

<div class="highlight"><pre><code class="objc"><span class="k">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">run:</span><span class="p">(</span><span class="n">NSError</span> <span class="o">**</span><span class="p">)</span><span class="nv">error</span><span class="p">{</span>
    <span class="kt">BOOL</span> <span class="n">successful</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span>
    <span class="n">CFSocketContext</span> <span class="n">socketCtxt</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="n">self</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">};</span>
    <span class="n">_socket</span> <span class="o">=</span> <span class="n">CFSocketCreate</span><span class="p">(</span><span class="n">kCFAllocatorDefault</span><span class="p">,</span> <span class="n">PF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> 
                             <span class="n">IPPROTO_TCP</span><span class="p">,</span> 
                             <span class="n">kCFSocketAcceptCallBack</span><span class="p">,</span>
                             <span class="p">(</span><span class="n">CFSocketCallBack</span><span class="p">)</span><span class="o">&amp;</span><span class="n">SocketConnectionAcceptedCallBack</span><span class="p">,</span>
                             <span class="o">&amp;</span><span class="n">socketCtxt</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">_socket</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">nil</span> <span class="o">!=</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="o">*</span><span class="n">error</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSError</span> <span class="n">alloc</span><span class="p">]</span> 
                      <span class="n">initWithDomain</span><span class="o">:</span><span class="n">ServerErrorDomain</span>
                      <span class="nl">code:</span><span class="n">kServerNoSocketsAvailable</span>
                      <span class="nl">userInfo:</span><span class="nb">nil</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="n">successful</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">YES</span> <span class="o">==</span> <span class="n">successful</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// enable address reuse</span>
        <span class="kt">int</span> <span class="n">yes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">setsockopt</span><span class="p">(</span><span class="n">CFSocketGetNative</span><span class="p">(</span><span class="n">_socket</span><span class="p">),</span> 
                   <span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">SO_REUSEADDR</span><span class="p">,</span>
                   <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">yes</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">yes</span><span class="p">));</span>
        <span class="kt">uint8_t</span> <span class="n">packetSize</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
        <span class="n">setsockopt</span><span class="p">(</span><span class="n">CFSocketGetNative</span><span class="p">(</span><span class="n">_socket</span><span class="p">),</span>
                   <span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">SO_SNDBUF</span><span class="p">,</span>
                   <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">packetSize</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">packetSize</span><span class="p">));</span>
        <span class="n">setsockopt</span><span class="p">(</span><span class="n">CFSocketGetNative</span><span class="p">(</span><span class="n">_socket</span><span class="p">),</span>
                   <span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">SO_RCVBUF</span><span class="p">,</span>
                   <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">packetSize</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">packetSize</span><span class="p">));</span>
        <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">addr4</span><span class="p">;</span>
        <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr4</span><span class="p">));</span>
        <span class="n">addr4</span><span class="p">.</span><span class="n">sin_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr4</span><span class="p">);</span>
        <span class="n">addr4</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
        <span class="n">addr4</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">CHAT_SERVER_PORT</span><span class="p">);</span> 
        <span class="n">addr4</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">INADDR_ANY</span><span class="p">);</span>
        <span class="n">NSData</span> <span class="o">*</span><span class="n">address4</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSData</span> <span class="n">dataWithBytes</span><span class="o">:&amp;</span><span class="n">addr4</span> <span class="n">length</span><span class="o">:</span><span class="k">sizeof</span><span class="p">(</span><span class="n">addr4</span><span class="p">)];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">kCFSocketSuccess</span> <span class="o">!=</span> <span class="n">CFSocketSetAddress</span><span class="p">(</span><span class="n">_socket</span><span class="p">,</span> <span class="p">(</span><span class="n">CFDataRef</span><span class="p">)</span><span class="n">address4</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="o">*</span><span class="n">error</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSError</span> <span class="n">alloc</span><span class="p">]</span> 
                                 <span class="n">initWithDomain</span><span class="o">:</span><span class="n">ServerErrorDomain</span>
                                 <span class="nl">code:</span><span class="n">kServerCouldNotBindToIPv4Address</span>
                                 <span class="nl">userInfo:</span><span class="nb">nil</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">_socket</span><span class="p">)</span> <span class="n">CFRelease</span><span class="p">(</span><span class="n">_socket</span><span class="p">);</span>
            <span class="n">_socket</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
            <span class="n">successful</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// now that the binding was successful, we get the port number </span>
            <span class="n">NSData</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="p">[(</span><span class="n">NSData</span> <span class="o">*</span><span class="p">)</span><span class="n">CFSocketCopyAddress</span><span class="p">(</span><span class="n">_socket</span><span class="p">)</span> <span class="n">autorelease</span><span class="p">];</span>
            <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr4</span><span class="p">,</span> <span class="p">[</span><span class="n">addr</span> <span class="n">bytes</span><span class="p">],</span> <span class="p">[</span><span class="n">addr</span> <span class="n">length</span><span class="p">]);</span>
            <span class="n">self</span><span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">addr4</span><span class="p">.</span><span class="n">sin_port</span><span class="p">);</span>
            <span class="c1">// 将socket 输入源加入到当前的runloop</span>
            <span class="n">CFRunLoopRef</span> <span class="n">cfrl</span> <span class="o">=</span> <span class="n">CFRunLoopGetCurrent</span><span class="p">();</span>
            <span class="n">CFRunLoopSourceRef</span> <span class="n">source4</span> <span class="o">=</span> <span class="n">CFSocketCreateRunLoopSource</span><span class="p">(</span><span class="n">kCFAllocatorDefault</span><span class="p">,</span> <span class="n">_socket</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
            <span class="n">CFRunLoopAddSource</span><span class="p">(</span><span class="n">cfrl</span><span class="p">,</span> <span class="n">source4</span><span class="p">,</span> <span class="n">kCFRunLoopDefaultMode</span><span class="p">);</span>
            <span class="n">CFRelease</span><span class="p">(</span><span class="n">source4</span><span class="p">);</span>             
            <span class="c1">//标准输入，当在命令行中输入时，回调函数便会被调用</span>
            <span class="n">CFFileDescriptorContext</span> <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="n">self</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">};</span>
            <span class="n">CFFileDescriptorRef</span> <span class="n">stdinFDRef</span> <span class="o">=</span> <span class="n">CFFileDescriptorCreate</span><span class="p">(</span><span class="n">kCFAllocatorDefault</span><span class="p">,</span> <span class="n">STDIN_FILENO</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">FileDescriptorCallBack</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">context</span><span class="p">);</span>
            <span class="n">CFFileDescriptorEnableCallBacks</span><span class="p">(</span><span class="n">stdinFDRef</span><span class="p">,</span><span class="n">kCFFileDescriptorReadCallBack</span><span class="p">);</span>
            <span class="n">CFRunLoopSourceRef</span> <span class="n">stdinSource</span> <span class="o">=</span> <span class="n">CFFileDescriptorCreateRunLoopSource</span><span class="p">(</span><span class="n">kCFAllocatorDefault</span><span class="p">,</span> <span class="n">stdinFDRef</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
            <span class="n">CFRunLoopAddSource</span><span class="p">(</span><span class="n">cfrl</span><span class="p">,</span> <span class="n">stdinSource</span><span class="p">,</span> <span class="n">kCFRunLoopDefaultMode</span><span class="p">);</span>
            <span class="n">CFRelease</span><span class="p">(</span><span class="n">stdinSource</span><span class="p">);</span>
            <span class="n">CFRelease</span><span class="p">(</span><span class="n">stdinFDRef</span><span class="p">);</span> 
            <span class="n">CFRunLoopRun</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">successful</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>


<p>当有客户端连接请求过来时， SocketConnectionAcceptedCallBack这个回调函数会被调用，根据新的全相关的socket，生成输入输出流，并设置输入输出流的delegate方法，将其添加到当前的runloop，这样流中有数据过来的时候，delegate方法会被调用。</p>

<p><strong>SocketConnectionAcceptedCallBack函数</strong></p>

<div class="highlight"><pre><code class="objc"><span class="k">static</span> <span class="kt">void</span> <span class="nf">SocketConnectionAcceptedCallBack</span><span class="p">(</span><span class="n">CFSocketRef</span> <span class="n">socket</span><span class="p">,</span> 
                                             <span class="n">CFSocketCallBackType</span> <span class="n">type</span><span class="p">,</span> 
                                             <span class="n">CFDataRef</span> <span class="n">address</span><span class="p">,</span> 
                                             <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ChatServer</span> <span class="o">*</span><span class="n">theChatServer</span> <span class="o">=</span> <span class="p">(</span><span class="n">ChatServer</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">kCFSocketAcceptCallBack</span> <span class="o">==</span> <span class="n">type</span><span class="p">)</span> <span class="p">{</span> 
        <span class="c1">// 摘自kCFSocketAcceptCallBack的文档，New connections will be automatically accepted and the callback is called with the data argument being a pointer to a CFSocketNativeHandle of the child socket. This callback is usable only with listening sockets.</span>
        <span class="n">CFSocketNativeHandle</span> <span class="n">nativeSocketHandle</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">CFSocketNativeHandle</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
        <span class="c1">// create the read and write streams for the connection to the other process</span>
        <span class="n">CFReadStreamRef</span> <span class="n">readStream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="n">CFWriteStreamRef</span> <span class="n">writeStream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="n">CFStreamCreatePairWithSocket</span><span class="p">(</span><span class="n">kCFAllocatorDefault</span><span class="p">,</span> <span class="n">nativeSocketHandle</span><span class="p">,</span>
                                     <span class="o">&amp;</span><span class="n">readStream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">writeStream</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="n">readStream</span> <span class="o">&amp;&amp;</span> <span class="nb">NULL</span> <span class="o">!=</span> <span class="n">writeStream</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">CFReadStreamSetProperty</span><span class="p">(</span><span class="n">readStream</span><span class="p">,</span> 
                                    <span class="n">kCFStreamPropertyShouldCloseNativeSocket</span><span class="p">,</span>
                                    <span class="n">kCFBooleanTrue</span><span class="p">);</span>
            <span class="n">CFWriteStreamSetProperty</span><span class="p">(</span><span class="n">writeStream</span><span class="p">,</span> 
                                     <span class="n">kCFStreamPropertyShouldCloseNativeSocket</span><span class="p">,</span>
                                     <span class="n">kCFBooleanTrue</span><span class="p">);</span>
            <span class="n">NSInputStream</span> <span class="o">*</span><span class="n">inputStream</span> <span class="o">=</span> <span class="p">(</span><span class="n">NSInputStream</span> <span class="o">*</span><span class="p">)</span><span class="n">readStream</span><span class="p">;</span><span class="c1">//toll-free bridging</span>
            <span class="n">NSOutputStream</span> <span class="o">*</span><span class="n">outputStream</span> <span class="o">=</span> <span class="p">(</span><span class="n">NSOutputStream</span> <span class="o">*</span><span class="p">)</span><span class="n">writeStream</span><span class="p">;</span><span class="c1">//toll-free bridging</span>
            <span class="n">inputStream</span><span class="p">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="n">theChatServer</span><span class="p">;</span>
            <span class="p">[</span><span class="n">inputStream</span> <span class="n">scheduleInRunLoop</span><span class="o">:</span><span class="p">[</span><span class="n">NSRunLoop</span> <span class="n">currentRunLoop</span><span class="p">]</span> <span class="n">forMode</span><span class="o">:</span><span class="n">NSDefaultRunLoopMode</span><span class="p">];</span>
            <span class="p">[</span><span class="n">inputStream</span> <span class="n">open</span><span class="p">];</span>
            <span class="n">outputStream</span><span class="p">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="n">theChatServer</span><span class="p">;</span>
            <span class="p">[</span><span class="n">outputStream</span> <span class="n">scheduleInRunLoop</span><span class="o">:</span><span class="p">[</span><span class="n">NSRunLoop</span> <span class="n">currentRunLoop</span><span class="p">]</span> <span class="n">forMode</span><span class="o">:</span><span class="n">NSDefaultRunLoopMode</span><span class="p">];</span>
            <span class="p">[</span><span class="n">outputStream</span> <span class="n">open</span><span class="p">];</span>
            <span class="n">Client</span> <span class="o">*</span><span class="n">aClient</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Client</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
            <span class="n">aClient</span><span class="p">.</span><span class="n">inputStream</span> <span class="o">=</span> <span class="n">inputStream</span><span class="p">;</span>
            <span class="n">aClient</span><span class="p">.</span><span class="n">outputStream</span> <span class="o">=</span> <span class="n">outputStream</span><span class="p">;</span>
            <span class="n">aClient</span><span class="p">.</span><span class="n">sock_fd</span> <span class="o">=</span> <span class="n">nativeSocketHandle</span><span class="p">;</span>
            <span class="p">[</span><span class="n">theChatServer</span><span class="p">.</span><span class="n">clients</span> <span class="n">setValue</span><span class="o">:</span><span class="n">aClient</span>  
                                     <span class="n">forKey</span><span class="o">:</span><span class="p">[</span><span class="n">NSString</span> <span class="n">stringWithFormat</span><span class="o">:</span><span class="s">@&quot;%d&quot;</span><span class="p">,</span><span class="n">inputStream</span><span class="p">]];</span>
            <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;有新客户端(sock_fd=%d)加入&quot;</span><span class="p">,</span><span class="n">nativeSocketHandle</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">close</span><span class="p">(</span><span class="n">nativeSocketHandle</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">readStream</span><span class="p">)</span> <span class="n">CFRelease</span><span class="p">(</span><span class="n">readStream</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">writeStream</span><span class="p">)</span> <span class="n">CFRelease</span><span class="p">(</span><span class="n">writeStream</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<p>当客户端有数据传过来时，相应的NSInputStream的delegate方法被调用</p>

<div class="highlight"><pre><code class="objc"> 
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="nf">stream:</span><span class="p">(</span><span class="n">NSStream</span><span class="o">*</span><span class="p">)</span><span class="nv">stream</span> <span class="nf">handleEvent:</span><span class="p">(</span><span class="n">NSStreamEvent</span><span class="p">)</span><span class="nv">eventCode</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">eventCode</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">NSStreamEventOpenCompleted</span>: <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="n">NSStreamEventHasBytesAvailable</span>: <span class="p">{</span>
            <span class="n">Client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">clients</span> <span class="n">objectForKey</span><span class="o">:</span><span class="p">[</span><span class="n">NSString</span> <span class="n">stringWithFormat</span><span class="o">:</span><span class="s">@&quot;%d&quot;</span><span class="p">,</span><span class="n">stream</span><span class="p">]];</span>
            <span class="n">NSMutableData</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSMutableData</span> <span class="n">data</span><span class="p">];</span>
            <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">));</span>
            <span class="n">NSUInteger</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">while</span><span class="p">([(</span><span class="n">NSInputStream</span><span class="o">*</span><span class="p">)</span><span class="n">stream</span> <span class="n">hasBytesAvailable</span><span class="p">])</span> <span class="p">{</span>
                <span class="n">len</span> <span class="o">=</span> <span class="p">[(</span><span class="n">NSInputStream</span><span class="o">*</span><span class="p">)</span><span class="n">stream</span> <span class="n">read</span><span class="o">:</span><span class="n">buf</span> <span class="n">maxLength</span><span class="o">:</span><span class="mi">128</span><span class="p">];</span>
                <span class="k">if</span><span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="p">[</span><span class="n">data</span> <span class="n">appendBytes</span><span class="o">:</span><span class="n">buf</span> <span class="n">length</span><span class="o">:</span><span class="n">len</span><span class="p">];</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">([</span><span class="n">data</span> <span class="n">length</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">//客户端退出</span>
                <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;客户端(sock_fd=%d)退出&quot;</span><span class="p">,</span><span class="n">client</span><span class="p">.</span><span class="n">sock_fd</span><span class="p">);</span>
                <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">clients</span> <span class="n">removeObjectForKey</span><span class="o">:</span><span class="p">[</span><span class="n">NSString</span> <span class="n">stringWithFormat</span><span class="o">:</span><span class="s">@&quot;%d&quot;</span><span class="p">,</span><span class="n">stream</span><span class="p">]];</span>
                <span class="n">close</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">sock_fd</span><span class="p">);</span>
            <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;收到客户端(sock_fd=%d)消息:%@&quot;</span><span class="p">,</span><span class="n">client</span><span class="p">.</span><span class="n">sock_fd</span><span class="p">,[[[</span><span class="n">NSString</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">initWithData</span><span class="o">:</span><span class="n">data</span> <span class="n">encoding</span><span class="o">:</span><span class="n">NSUTF8StringEncoding</span><span class="p">]</span> <span class="n">autorelease</span><span class="p">]);</span>
            <span class="p">}</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="n">NSStreamEventHasSpaceAvailable</span>: <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="n">NSStreamEventEndEncountered</span>: <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="n">NSStreamEventErrorOccurred</span>: <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nl">default:</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<p>当在debug窗口中输入内容并回车时，标准输入缓冲区中便有数据了，这个时候回调函数FileDescriptorCallBack将被调用，处理标准输入。</p>

<div class="highlight"><pre><code class="objc"><span class="k">static</span> <span class="kt">void</span> <span class="nf">FileDescriptorCallBack</span><span class="p">(</span><span class="n">CFFileDescriptorRef</span> <span class="n">f</span><span class="p">,</span>
                                   <span class="n">CFOptionFlags</span> <span class="n">callBackTypes</span><span class="p">,</span>
                                   <span class="kt">void</span> <span class="o">*</span><span class="n">info</span><span class="p">){</span>
    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">CFFileDescriptorGetNativeDescriptor</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
    <span class="n">ChatServer</span> <span class="o">*</span><span class="n">theChatServer</span> <span class="o">=</span> <span class="p">(</span><span class="n">ChatServer</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">==</span> <span class="n">STDIN_FILENO</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NSData</span> <span class="o">*</span><span class="n">inputData</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSFileHandle</span> <span class="n">fileHandleWithStandardInput</span><span class="p">]</span> <span class="n">availableData</span><span class="p">];</span>
        <span class="n">NSString</span> <span class="o">*</span><span class="n">inputString</span> <span class="o">=</span> <span class="p">[[[</span><span class="n">NSString</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">initWithData</span><span class="o">:</span><span class="n">inputData</span> <span class="n">encoding</span><span class="o">:</span><span class="n">NSUTF8StringEncoding</span><span class="p">]</span> <span class="n">autorelease</span><span class="p">];</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;准备发送消息:%@&quot;</span><span class="p">,</span><span class="n">inputString</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">Client</span> <span class="o">*</span><span class="n">client</span> <span class="k">in</span> <span class="p">[</span><span class="n">theChatServer</span><span class="p">.</span><span class="n">clients</span> <span class="n">allValues</span><span class="p">])</span> <span class="p">{</span>
            <span class="p">[</span><span class="n">client</span><span class="p">.</span><span class="n">outputStream</span> <span class="n">write</span><span class="o">:</span><span class="p">[</span><span class="n">inputData</span> <span class="n">bytes</span><span class="p">]</span> <span class="n">maxLength</span><span class="o">:</span><span class="p">[</span><span class="n">inputData</span> <span class="n">length</span><span class="p">]];</span>
        <span class="p">}</span>
        <span class="c1">//处理完数据之后必须重新Enable 回调函数</span>
        <span class="n">CFFileDescriptorEnableCallBacks</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">kCFFileDescriptorReadCallBack</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>




</section>
<section class="meta">
<span class="author">
  <a href="http://geeklu.com">海涛</a>
</span>
<span class="time">
  /
  <time datetime="2012-01-31">2012-01-31</time>
</span>
<br />
<span class="license">
  Published under <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">(CC) BY-NC-SA</a>
</span>

<span class="categories">
  in categories
  
  <a href="/categories/#programming" title="programming">programming</a>&nbsp;
  
</span>


<span class="tags">
  tagged with 
  
  <a href="/tags/#Socket" title="Socket">Socket</a>&nbsp;
  
  <a href="/tags/#C" title="C">C</a>&nbsp;
  
</span>

</section>
<section class="comment">
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'Haitao'; // required: replace example with your forum shortname
    var disqus_url = '/2012/01/macios-socket/';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</section>


<script type="text/javascript">
$(function(){
  $(document).keydown(function(e) {
    var url = false;
        if (e.which == 37 || e.which == 74) {  // Left arrow and J
            
        url = '/2012/01/ios-persistence/';
        
        }
        else if (e.which == 39 || e.which == 75) {  // Right arrow and K
            
        url = '/2012/02/bonjour/';
        
        }
        if (url) {
            window.location = url;
        }
  });
})
</script>


        </article>
      </div>

    <footer>
        <p><small>Powered by <a href="https://github.com/mojombo/jekyll">Jekyll</a> | Copyright 2008 - 2013 by <a href="http://geeklu.com/about/">Luke</a> | <span class="label label-info">2013-08-29 18:27:01 CST</span></small></p>
    </footer>

    </div>

    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-12936429-2']);
      _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </body>
</html>
