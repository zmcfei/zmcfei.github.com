<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="author" content="海涛" />
    <title>Core Text 入门 | 海涛</title>
    <link href="data:image/x-icon;base64,AAABAAEAEBAQAAAAAAAoAQAAFgAAACgAAAAQAAAAIAAAAAEABAAAAAAAgAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAD/APr59wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIiIiIiIiAAAiIiIiIiIAACIiIiIiIgERERERERIiAREREREREiIBERERERESIgERIiIiERIiAREiIiIREiIBESIhERESIgERIiERERIiAREiIiIiIiIBESIiIiIiIgERIiIiIiIiAREREREREAABEREREREQAAERERERERAADgAQAA4AEAAOABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAAEAAAABAAAAAQAAAA8AAAAPAAAADwAA" rel="icon" type="image/x-icon" />
    <link href="/feed/" rel="alternate" title="海涛" type="application/atom+xml" />
    
    <link rel="stylesheet" href="/media/css/highlight.css">
    <link href='/media/webfonts/ss-social.css' rel='stylesheet'>
    <link href='/media/webfonts/ss-standard.css' rel='stylesheet'>
    <link href="/media/css/screen.css" rel="stylesheet">

    <script type="text/javascript" src="/media/js/jquery-1.7.1.min.js"></script>
  </head>
  <body>
    <div id="container">
      <div id="main" role="main">
        <header>
        <div class="buttons">
          <a href="/" class="ss-icon" title="Go to homepage">home</a>
          <a href="/categories" class="ss-icon" title="Category" >list</a>
          <a href="/tags" class="ss-icon" title="Tag Cloud" >tags</a>
          <a href="/guestbook" class="ss-icon" title="Guest Book" >talk</a>
          <a href="/about" class="ss-icon" title="About" >user</a>
          <a href="/feed" class="ss-icon" title="Subscribe by RSS" >rss</a>
        </div>
        <h1>Core Text 入门</h1>
        </header>
        <hr>
        <article class="content">
        <section class="post">
<blockquote><p>本文所涉及的代码你可以在这里下载到 <a href="https://github.com/kejinlu/CTTest">https://github.com/kejinlu/CTTest</a>，包含两个项目，一个Mac的NSTextView的测试项目，一个iOS的Core Text的测试项目</p></blockquote>

<h2>NSTextView和Attribued String</h2>

<hr />

<p>第一次接触苹果系的富文本编程是在写Mac平台上的一个输入框的时候，输入框中的文字可以设置各种样式，并可以在文字中间插入图片，好在Mac的AppKit中提供了NSTextView这个支持富文本编辑器控件。此控件背后是通过什么方式来描述富文本的呢？答案是NSAttributedString，很多编程语言都提供了AttributedString的概念。NSAttributedString比NSString多了一个Attribute的概念，一个NSAttributedString的对象包含很多的属性，每一个属性都有其对应的字符区域，在这里是使用NSRange来进行描述的。下面是一个NSTextView显示富文本的例子</p>

<div class="highlight"><pre><code class="objc"><span class="n">NSMutableAttributedString</span> <span class="o">*</span><span class="n">attributedString</span> <span class="o">=</span> <span class="p">[[[</span><span class="n">NSMutableAttributedString</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">initWithString</span><span class="o">:</span><span class="s">@&quot;测试富文本显示&quot;</span><span class="p">]</span> <span class="n">autorelease</span><span class="p">];</span>
<span class="c1">//为所有文本设置字体</span>
<span class="p">[</span><span class="n">attributedString</span> <span class="n">addAttribute</span><span class="o">:</span><span class="n">NSFontAttributeName</span> <span class="n">value</span><span class="o">:</span><span class="p">[</span><span class="n">NSFont</span> <span class="n">systemFontOfSize</span><span class="o">:</span><span class="mi">24</span><span class="p">]</span> <span class="n">range</span><span class="o">:</span><span class="n">NSMakeRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="n">attributedString</span> <span class="n">length</span><span class="p">])];</span>
<span class="c1">//将“测试”两字字体颜色设置为蓝色</span>
<span class="p">[</span><span class="n">attributedString</span> <span class="n">addAttribute</span><span class="o">:</span><span class="n">NSForegroundColorAttributeName</span> <span class="n">value</span><span class="o">:</span><span class="p">[</span><span class="n">NSColor</span> <span class="n">blueColor</span><span class="p">]</span> <span class="n">range</span><span class="o">:</span><span class="n">NSMakeRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)];</span>
<span class="c1">//将“富文本”三个字字体颜色设置为红色</span>
<span class="p">[</span><span class="n">attributedString</span> <span class="n">addAttribute</span><span class="o">:</span><span class="n">NSForegroundColorAttributeName</span> <span class="n">value</span><span class="o">:</span><span class="p">[</span><span class="n">NSColor</span> <span class="n">redColor</span><span class="p">]</span> <span class="n">range</span><span class="o">:</span><span class="n">NSMakeRange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)];</span>
    
<span class="c1">//在“测”和“试”两字之间插入一张图片</span>
<span class="n">NSString</span> <span class="o">*</span><span class="n">imageName</span> <span class="o">=</span> <span class="s">@&quot;taobao.png&quot;</span><span class="p">;</span>
<span class="n">NSFileWrapper</span> <span class="o">*</span><span class="n">imageFileWrapper</span> <span class="o">=</span> <span class="p">[[[</span><span class="n">NSFileWrapper</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">initRegularFileWithContents</span><span class="o">:</span><span class="p">[[</span><span class="n">NSImage</span> <span class="n">imageNamed</span><span class="o">:</span><span class="n">imageName</span><span class="p">]</span> <span class="n">TIFFRepresentation</span><span class="p">]]</span> <span class="n">autorelease</span><span class="p">];</span>
<span class="n">imageFileWrapper</span><span class="p">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">imageName</span><span class="p">;</span>
<span class="n">imageFileWrapper</span><span class="p">.</span><span class="n">preferredFilename</span> <span class="o">=</span> <span class="n">imageName</span><span class="p">;</span>
    
<span class="n">NSTextAttachment</span> <span class="o">*</span><span class="n">imageAttachment</span> <span class="o">=</span> <span class="p">[[[</span><span class="n">NSTextAttachment</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">initWithFileWrapper</span><span class="o">:</span><span class="n">imageFileWrapper</span><span class="p">]</span> <span class="n">autorelease</span><span class="p">];</span>
<span class="n">NSAttributedString</span> <span class="o">*</span><span class="n">imageAttributedString</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSAttributedString</span> <span class="n">attributedStringWithAttachment</span><span class="o">:</span><span class="n">imageAttachment</span><span class="p">];</span>
<span class="p">[</span><span class="n">attributedString</span> <span class="n">insertAttributedString</span><span class="o">:</span><span class="n">imageAttributedString</span> <span class="n">atIndex</span><span class="o">:</span><span class="mi">1</span><span class="p">];</span>

<span class="cm">/*</span>
<span class="cm">其实插入图片附件之后 attributedString的长度增加了1 变成了8，所以可以预见其实图片附件属性对应的内容应该是一个长度的字符</span>
<span class="cm">Printing description of attributedString:</span>
<span class="cm">测{</span>
<span class="cm">    NSColor = &quot;NSCalibratedRGBColorSpace 0 0 1 1&quot;;</span>
<span class="cm">    NSFont = &quot;\&quot;LucidaGrande 24.00 pt. P [] (0x10051bfd0) fobj=0x101e687f0, spc=7.59\&quot;&quot;;</span>
<span class="cm">}￼{</span>
<span class="cm">    NSAttachment = &quot;&lt;NSTextAttachment: 0x101e0c9c0&gt; \&quot;taobao.png\&quot;&quot;;</span>
<span class="cm">}试{</span>
<span class="cm">    NSColor = &quot;NSCalibratedRGBColorSpace 0 0 1 1&quot;;</span>
<span class="cm">    NSFont = &quot;\&quot;LucidaGrande 24.00 pt. P [] (0x10051bfd0) fobj=0x101e687f0, spc=7.59\&quot;&quot;;</span>
<span class="cm">}富文本{</span>
<span class="cm">    NSColor = &quot;NSCalibratedRGBColorSpace 1 0 0 1&quot;;</span>
<span class="cm">    NSFont = &quot;\&quot;LucidaGrande 24.00 pt. P [] (0x10051bfd0) fobj=0x101e687f0, spc=7.59\&quot;&quot;;</span>
<span class="cm">}显示{</span>
<span class="cm">    NSFont = &quot;\&quot;LucidaGrande 24.00 pt. P [] (0x10051bfd0) fobj=0x101e687f0, spc=7.59\&quot;&quot;;</span>
<span class="cm">}</span>
<span class="cm">*/</span>


<span class="p">[</span><span class="n">_textView</span> <span class="n">insertText</span><span class="o">:</span><span class="n">attributedString</span><span class="p">];</span>
</code></pre></div>


<p><img src="http://ww1.sinaimg.cn/bmiddle/65cc0af7gw1e2rnc6to9cj.jpg" alt="" /></p>

<p>还有就是NSAttributedString提供对所有属性进行遍历的方法，也提供了计算在特定size下渲染实际所占的区域（boundingRectWithSize:options:） 这些这里就不介绍了。
从上面的代码可以看出其实Mac下的富文本的渲染并不是很复杂，只要将Attributed String理解和使用好，其余的事情都交给NSTextView来做了，你完全不用考虑其底层是如何取渲染的。但是在iOS平台上就没有这么幸运了，虽然iOS从3。2开始也提供了NSAttributedString，但是并没有类似NSTextView这样的控件直接来渲染Attributed String。
这个时候你就得使用Core Text了。</p>

<p><br/>
<br/></p>

<h2>Core Text</h2>

<hr />

<p>下面讨论的Core Text相关编程都是特指在iOS平台下。
Core Text是和Core Graphics配合使用的，一般是在UIView的drawRect方法中的Graphics Context上进行绘制的。
且Core Text真正负责绘制的是文本部分，图片还是需要自己去手动绘制，所以你必须关注很多绘制的细节部分。</p>

<h3>一.Core Text知识准备</h3>

<p>在进入任何一个新的编程领域之前，我们肯定要先接触相关的领域模型的知识。比如你软件是进行科学计算的，那么你就必须理解大量的数学原理；如果你的软件是搞银行系统，那么你就得事先了解相关的银行的业务知识。这些都是不可避免的事情。通常情况下领域知识具有较高的通用性。但在特定的环境下，某些知识点也会被特殊处理。
Core Text是用来进行文字精细排版的，所以了解文字相关的知识也不可避免。</p>

<h4>1.字符（Character）和字形（Glyphs）</h4>

<p>排版系统中文本显示的一个重要的过程就是字符到字形的转换，字符是信息本身的元素，而字形是字符的图形表征，字符还会有其它表征比如发音。
字符在计算机中其实就是一个编码，某个字符集中的编码，比如Unicode字符集，就囊括了大都数存在的字符。
而字形则是图形，一般都存储在字体文件中，字形也有它的编码，也就是它在字体中的索引。
一个字符可以对应多个字形（不同的字体，或者同种字体的不同样式:粗体斜体等）；多个字符也可能对应一个字形，比如字符的连写（ Ligatures）。 <br/>
<img src="http://ww1.sinaimg.cn/large/65cc0af7gw1e2u5ypr899g.gif" alt="" />  <br/>
Roman Ligatures</p>

<p>下面就来详情看看字形的各个参数也就是所谓的字形度量Glyph Metrics</p>

<p><img src="http://ww3.sinaimg.cn/large/65cc0af7jw1e2ucdlrkfbg.gif" alt="" />    <br/>
<img src="http://ww2.sinaimg.cn/large/65cc0af7gw1e2u242uytyg.gif" alt="" /></p>

<ul>
<li>bounding box（边界框 bbox），这是一个假想的框子，它尽可能紧密的装入字形。</li>
<li>baseline（基线），一条假想的线,一行上的字形都以此线作为上下位置的参考，在这条线的左侧存在一个点叫做基线的原点，</li>
<li>ascent（上行高度）从原点到字体中最高（这里的高深都是以基线为参照线的）的字形的顶部的距离，ascent是一个正值</li>
<li>descent（下行高度）从原点到字体中最深的字形底部的距离，descent是一个负值（比如一个字体原点到最深的字形的底部的距离为2，那么descent就为-2）</li>
<li>linegap（行距），linegap也可以称作leading（其实准确点讲应该叫做External leading）,行高lineHeight则可以通过 ascent + |descent| + linegap 来计算。</li>
</ul>


<p>一些Metrics专业知识还可以参考Free Type的文档 <a href="http://www.freetype.org/freetype2/docs/glyphs/glyphs-3.html">Glyph metrics</a>，其实iOS就是使用<a href="http://www.freetype.org/">Free Type</a>库来进行字体渲染的。</p>

<p>以上图片和部分概念来自苹果文档 <a href="http://developer.apple.com/library/mac/#documentation/TextFonts/Conceptual/CocoaTextArchitecture/FontHandling/FontHandling.html#//apple_ref/doc/uid/TP40009459-CH5-SW18">Querying Font Metrics</a> ，<a href="http://developer.apple.com/library/mac/documentation/TextFonts/Conceptual/CocoaTextArchitecture/TypoFeatures/TextSystemFeatures.html#//apple_ref/doc/uid/TP40009459-CH6-51627-BBCCHIFF">Text Layout</a></p>

<h4>2.坐标系</h4>

<p>首先不得不说 苹果编程中的坐标系花样百出，经常让开发者措手不及。
传统的Mac中的坐标系的原点在左下角，比如NSView默认的坐标系，原点就在左下角。但Mac中有些View为了其实现的便捷将原点变换到左上角，像NSTableView的坐标系坐标原点就在左上角。iOS UIKit的UIView的坐标系原点在左上角。 <br/>
往底层看，Core Graphics的context使用的坐标系的原点是在左下角。而在iOS中的底层界面绘制就是通过Core Graphics进行的，那么坐标系列是如何变换的呢？
在UIView的drawRect方法中我们可以通过UIGraphicsGetCurrentContext()来获得当前的Graphics Context。drawRect方法在被调用前，这个Graphics Context被创建和配置好，你只管使用便是。如果你细心，通过CGContextGetCTM(CGContextRef c)可以看到其返回的值并不是CGAffineTransformIdentity，通过打印出来看到值为</p>

<pre><code>Printing description of contextCTM:
(CGAffineTransform) contextCTM = {
        a = 1
        b = 0
        c = 0
        d = -1
        tx = 0
        ty = 460
}       
</code></pre>

<p>这是非retina分辨率下的结果，如果是如果是retina上面的a,d,ty的值将会乘2，如果是iPhone 5，ty的值会再大些。
但是作用都是一样的就是将上下文空间坐标系进行了flip，使得原本左下角原点变到左上角，y轴正方向也变换成向下。</p>

<p>上面说了一大堆，下面进入正题，Core Text一开始便是定位于桌面的排版系统，使用了传统的原点在左下角的坐标系，所以它在绘制文本的时候都是参照左下角的原点进行绘制的。
但是iOS的UIView的drawRect方法的context被做了次flip，如果你啥也不做处理，直接在这个context上进行Core Text绘制，你会发现文字是镜像且上下颠倒。  <br/>
<img src="http://ww4.sinaimg.cn/large/65cc0af7gw1e2uwkpr6rfj.jpg" alt="" />  <br/>
所以在UIView的drawRect方法中的context上进行Core Text绘制之前需要对context进行一次Flip。    <br/>
<img src="http://ww1.sinaimg.cn/large/65cc0af7gw1e2uwlh7zvej.jpg" alt="" /></p>

<p>这里再提及一个函数CGContextSetTextMatrix，它可以用来为每一个显示的字形单独设置变形矩阵。</p>

<h4>3.NSMutableAttributedString 和 CFMutableAttributedStringRef</h4>

<p>Core Foundation和Foundation中的有些数据类型只需要简单的强制类型转换就可以互换使用，这类类型我们叫他们为<a href="http://developer.apple.com/library/mac/#documentation/CoreFoundation/Conceptual/CFDesignConcepts/Articles/tollFreeBridgedTypes.html">Toll-Free Bridged Types</a>。 <br/>
CFMutableAttributedStringRef和NSMutableAttributedString就是其中的一对，Core Foundation的接口基本是C的接口，功能强大，但是使用起来没有Foundation中提供的Objc的接口简单好使，所以很多时候我们可以使用高层接口组织数据，然后将其传给低层函数接口使用。</p>

<h3>二.Core Text对象模型</h3>

<p>这节主要来看看Core Text绘制的一些细节问题了，首先是Core Text绘制的流程： <br/>
<img src="http://ww1.sinaimg.cn/large/65cc0af7gw1e2uxd1gmhwj.jpg" alt="" /></p>

<p><img src="http://ww4.sinaimg.cn/large/65cc0af7gw1e2uyn6r88oj.jpg" alt="" /></p>

<ul>
<li>framesetter  framesetter对应的类型是 CTFramesetter，通过CFAttributedString进行初始化，它作为CTFrame对象的生产工厂，负责根据path生产对应的CTFrame</li>
<li>CTFrame CTFrame是可以通过CTFrameDraw函数直接绘制到context上的，当然你可以在绘制之前，操作CTFrame中的CTLine，进行一些参数的微调</li>
<li>CTLine 可以看做Core Text绘制中的一行的对象 通过它可以获得当前行的line ascent,line descent ,line leading,还可以获得Line下的所有Glyph Runs</li>
<li>CTRun 或者叫做 Glyph Run，是一组共享想相同attributes（属性）的字形的集合体</li>
</ul>


<p>上面说了这么多对也没一个东西和图片绘制有关系，其实吧，Core Text本身并不支持图片绘制，图片的绘制你还得通过Core Graphics来进行。只是Core Text可以通过CTRun的设置为你的图片在文本绘制的过程中留出适当的空间。这个设置就使用到CTRunDelegate了，看这个名字大概就可以知道什么意思了，CTRunDelegate作为CTRun相关属性或操作扩展的一个入口，使得我们可以对CTRun做一些自定义的行为。为图片留位置的方法就是加入一个空白的CTRun，自定义其ascent，descent，width等参数，使得绘制文本的时候留下空白位置给相应的图片。然后图片在相应的空白位置上使用Core Graphics接口进行绘制。 <br/>
使用CTRunDelegateCreate可以创建一个CTRunDelegate，它接收两个参数，一个是callbacks结构体，一个是所有callback调用的时候需要传入的对象。
callbacks的结构体为CTRunDelegateCallbacks，主要是包含一些回调函数，比如有返回当前run的ascent，descent，width这些值的回调函数，至于函数中如何鉴别当前是哪个run，可以在CTRunDelegateCreate的第二个参数来达到目的，因为CTRunDelegateCreate的第二个参数会作为每一个回调调用时的入参。</p>

<h3>三.Core Text实战</h3>

<p>这里使用Core Text实现一个和之前NSTextView显示类似的图文混排的例子。</p>

<p><img src="http://ww4.sinaimg.cn/large/65cc0af7gw1e2v3mj0xsrj.jpg" alt="" /></p>

<p>直接贴上代码大家体会下:</p>

<div class="highlight"><pre><code class="objc"><span class="kt">void</span> <span class="nf">RunDelegateDeallocCallback</span><span class="p">(</span> <span class="kt">void</span><span class="o">*</span> <span class="n">refCon</span> <span class="p">){</span>
    
<span class="p">}</span>

<span class="n">CGFloat</span> <span class="nf">RunDelegateGetAscentCallback</span><span class="p">(</span> <span class="kt">void</span> <span class="o">*</span><span class="n">refCon</span> <span class="p">){</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">imageName</span> <span class="o">=</span> <span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="n">refCon</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">UIImage</span> <span class="n">imageNamed</span><span class="o">:</span><span class="n">imageName</span><span class="p">].</span><span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">CGFloat</span> <span class="nf">RunDelegateGetDescentCallback</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">refCon</span><span class="p">){</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">CGFloat</span> <span class="nf">RunDelegateGetWidthCallback</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">refCon</span><span class="p">){</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">imageName</span> <span class="o">=</span> <span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="n">refCon</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">UIImage</span> <span class="n">imageNamed</span><span class="o">:</span><span class="n">imageName</span><span class="p">].</span><span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">drawRect:</span><span class="p">(</span><span class="n">CGRect</span><span class="p">)</span><span class="nv">rect</span>
<span class="p">{</span>
    <span class="n">CGContextRef</span> <span class="n">context</span> <span class="o">=</span> <span class="n">UIGraphicsGetCurrentContext</span><span class="p">();</span>
    
    <span class="c1">//这四行代码只是简单测试drawRect中context的坐标系</span>
    <span class="n">CGContextSetRGBFillColor</span> <span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">CGContextFillRect</span> <span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">CGRectMake</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">100</span> <span class="p">));</span>
    <span class="n">CGContextSetRGBFillColor</span> <span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">.5</span><span class="p">);</span>
    <span class="n">CGContextFillRect</span> <span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">CGRectMake</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">));</span>
    
    <span class="n">CGContextSetTextMatrix</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">CGAffineTransformIdentity</span><span class="p">);</span><span class="c1">//设置字形变换矩阵为CGAffineTransformIdentity，也就是说每一个字形都不做图形变换</span>
    
    <span class="n">CGAffineTransform</span> <span class="n">flipVertical</span> <span class="o">=</span> <span class="n">CGAffineTransformMake</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">self</span><span class="p">.</span><span class="n">bounds</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
    <span class="n">CGContextConcatCTM</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">flipVertical</span><span class="p">);</span><span class="c1">//将当前context的坐标系进行flip</span>
    
    <span class="n">NSMutableAttributedString</span> <span class="o">*</span><span class="n">attributedString</span> <span class="o">=</span> <span class="p">[[[</span><span class="n">NSMutableAttributedString</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">initWithString</span><span class="o">:</span><span class="s">@&quot;测试富文本显示&quot;</span><span class="p">]</span> <span class="n">autorelease</span><span class="p">];</span>
    
    <span class="c1">//为所有文本设置字体</span>
    <span class="c1">//[attributedString addAttribute:NSFontAttributeName value:[UIFont systemFontOfSize:24] range:NSMakeRange(0, [attributedString length])]; // 6.0+</span>
    <span class="n">UIFont</span> <span class="o">*</span><span class="n">font</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIFont</span> <span class="n">systemFontOfSize</span><span class="o">:</span><span class="mi">24</span><span class="p">];</span>
    <span class="n">CTFontRef</span> <span class="n">fontRef</span> <span class="o">=</span> <span class="n">CTFontCreateWithName</span><span class="p">((</span><span class="n">CFStringRef</span><span class="p">)</span><span class="n">font</span><span class="p">.</span><span class="n">fontName</span><span class="p">,</span> <span class="n">font</span><span class="p">.</span><span class="n">pointSize</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="p">[</span><span class="n">attributedString</span> <span class="n">addAttribute</span><span class="o">:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="n">kCTFontAttributeName</span> <span class="n">value</span><span class="o">:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="n">fontRef</span> <span class="n">range</span><span class="o">:</span><span class="n">NSMakeRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="n">attributedString</span> <span class="n">length</span><span class="p">])];</span>
    
    <span class="c1">//将“测试”两字字体颜色设置为蓝色</span>
    <span class="c1">//[attributedString addAttribute:NSForegroundColorAttributeName value:[UIColor blueColor] range:NSMakeRange(0, 2)]; //6.0+</span>
    <span class="p">[</span><span class="n">attributedString</span> <span class="n">addAttribute</span><span class="o">:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="n">kCTForegroundColorAttributeName</span> <span class="n">value</span><span class="o">:</span><span class="p">(</span><span class="kt">id</span><span class="p">)[</span><span class="n">UIColor</span> <span class="n">blueColor</span><span class="p">].</span><span class="n">CGColor</span> <span class="n">range</span><span class="o">:</span><span class="n">NSMakeRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)];</span>
    
    <span class="c1">//将“富文本”三个字字体颜色设置为红色</span>
    <span class="c1">//[attributedString addAttribute:NSForegroundColorAttributeName value:[UIColor redColor] range:NSMakeRange(2, 3)]; //6.0+</span>
    <span class="p">[</span><span class="n">attributedString</span> <span class="n">addAttribute</span><span class="o">:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="n">kCTForegroundColorAttributeName</span> <span class="n">value</span><span class="o">:</span><span class="p">(</span><span class="kt">id</span><span class="p">)[</span><span class="n">UIColor</span> <span class="n">redColor</span><span class="p">].</span><span class="n">CGColor</span> <span class="n">range</span><span class="o">:</span><span class="n">NSMakeRange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)];</span>
    
    
    <span class="c1">//为图片设置CTRunDelegate,delegate决定留给图片的空间大小</span>
    <span class="n">NSString</span> <span class="o">*</span><span class="n">taobaoImageName</span> <span class="o">=</span> <span class="s">@&quot;taobao.png&quot;</span><span class="p">;</span>
    <span class="n">CTRunDelegateCallbacks</span> <span class="n">imageCallbacks</span><span class="p">;</span>
    <span class="n">imageCallbacks</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">kCTRunDelegateVersion1</span><span class="p">;</span>
    <span class="n">imageCallbacks</span><span class="p">.</span><span class="n">dealloc</span> <span class="o">=</span> <span class="n">RunDelegateDeallocCallback</span><span class="p">;</span>
    <span class="n">imageCallbacks</span><span class="p">.</span><span class="n">getAscent</span> <span class="o">=</span> <span class="n">RunDelegateGetAscentCallback</span><span class="p">;</span>
    <span class="n">imageCallbacks</span><span class="p">.</span><span class="n">getDescent</span> <span class="o">=</span> <span class="n">RunDelegateGetDescentCallback</span><span class="p">;</span>
    <span class="n">imageCallbacks</span><span class="p">.</span><span class="n">getWidth</span> <span class="o">=</span> <span class="n">RunDelegateGetWidthCallback</span><span class="p">;</span>
    <span class="n">CTRunDelegateRef</span> <span class="n">runDelegate</span> <span class="o">=</span> <span class="n">CTRunDelegateCreate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">imageCallbacks</span><span class="p">,</span> <span class="n">taobaoImageName</span><span class="p">);</span>
    <span class="n">NSMutableAttributedString</span> <span class="o">*</span><span class="n">imageAttributedString</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSMutableAttributedString</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">initWithString</span><span class="o">:</span><span class="s">@&quot; &quot;</span><span class="p">];</span><span class="c1">//空格用于给图片留位置</span>
    <span class="p">[</span><span class="n">imageAttributedString</span> <span class="n">addAttribute</span><span class="o">:</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="n">kCTRunDelegateAttributeName</span> <span class="n">value</span><span class="o">:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="n">runDelegate</span> <span class="n">range</span><span class="o">:</span><span class="n">NSMakeRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)];</span>
    <span class="n">CFRelease</span><span class="p">(</span><span class="n">runDelegate</span><span class="p">);</span>
    
    <span class="p">[</span><span class="n">imageAttributedString</span> <span class="n">addAttribute</span><span class="o">:</span><span class="s">@&quot;imageName&quot;</span> <span class="n">value</span><span class="o">:</span><span class="n">taobaoImageName</span> <span class="n">range</span><span class="o">:</span><span class="n">NSMakeRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)];</span>
    
    <span class="p">[</span><span class="n">attributedString</span> <span class="n">insertAttributedString</span><span class="o">:</span><span class="n">imageAttributedString</span> <span class="n">atIndex</span><span class="o">:</span><span class="mi">1</span><span class="p">];</span>
    
    <span class="n">CTFramesetterRef</span> <span class="n">ctFramesetter</span> <span class="o">=</span> <span class="n">CTFramesetterCreateWithAttributedString</span><span class="p">((</span><span class="n">CFMutableAttributedStringRef</span><span class="p">)</span><span class="n">attributedString</span><span class="p">);</span>
    
    <span class="n">CGMutablePathRef</span> <span class="n">path</span> <span class="o">=</span> <span class="n">CGPathCreateMutable</span><span class="p">();</span>
    <span class="n">CGRect</span> <span class="n">bounds</span> <span class="o">=</span> <span class="n">CGRectMake</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">bounds</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">bounds</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
    <span class="n">CGPathAddRect</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">bounds</span><span class="p">);</span>
    
    <span class="n">CTFrameRef</span> <span class="n">ctFrame</span> <span class="o">=</span> <span class="n">CTFramesetterCreateFrame</span><span class="p">(</span><span class="n">ctFramesetter</span><span class="p">,</span><span class="n">CFRangeMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">path</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">CTFrameDraw</span><span class="p">(</span><span class="n">ctFrame</span><span class="p">,</span> <span class="n">context</span><span class="p">);</span>
    
    <span class="n">CFArrayRef</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">CTFrameGetLines</span><span class="p">(</span><span class="n">ctFrame</span><span class="p">);</span>
    <span class="n">CGPoint</span> <span class="n">lineOrigins</span><span class="p">[</span><span class="n">CFArrayGetCount</span><span class="p">(</span><span class="n">lines</span><span class="p">)];</span>
    <span class="n">CTFrameGetLineOrigins</span><span class="p">(</span><span class="n">ctFrame</span><span class="p">,</span> <span class="n">CFRangeMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">lineOrigins</span><span class="p">);</span>
    
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CFArrayGetCount</span><span class="p">(</span><span class="n">lines</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">CTLineRef</span> <span class="n">line</span> <span class="o">=</span> <span class="n">CFArrayGetValueAtIndex</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
        <span class="n">CGFloat</span> <span class="n">lineAscent</span><span class="p">;</span>
        <span class="n">CGFloat</span> <span class="n">lineDescent</span><span class="p">;</span>
        <span class="n">CGFloat</span> <span class="n">lineLeading</span><span class="p">;</span>
        <span class="n">CTLineGetTypographicBounds</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lineAscent</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lineDescent</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lineLeading</span><span class="p">);</span>
        
        <span class="n">CFArrayRef</span> <span class="n">runs</span> <span class="o">=</span> <span class="n">CTLineGetGlyphRuns</span><span class="p">(</span><span class="n">line</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">CFArrayGetCount</span><span class="p">(</span><span class="n">runs</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">CGFloat</span> <span class="n">runAscent</span><span class="p">;</span>
            <span class="n">CGFloat</span> <span class="n">runDescent</span><span class="p">;</span>
            <span class="n">CGPoint</span> <span class="n">lineOrigin</span> <span class="o">=</span> <span class="n">lineOrigins</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
            <span class="n">CTRunRef</span> <span class="n">run</span> <span class="o">=</span> <span class="n">CFArrayGetValueAtIndex</span><span class="p">(</span><span class="n">runs</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
            <span class="n">NSDictionary</span><span class="o">*</span> <span class="n">attributes</span> <span class="o">=</span> <span class="p">(</span><span class="n">NSDictionary</span><span class="o">*</span><span class="p">)</span><span class="n">CTRunGetAttributes</span><span class="p">(</span><span class="n">run</span><span class="p">);</span>
            <span class="n">CGRect</span> <span class="n">runRect</span><span class="p">;</span>
            <span class="n">runRect</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">CTRunGetTypographicBounds</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">CFRangeMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">runAscent</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">runDescent</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
            
            <span class="n">runRect</span><span class="o">=</span><span class="n">CGRectMake</span><span class="p">(</span><span class="n">lineOrigin</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">CTLineGetOffsetForStringIndex</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">CTRunGetStringRange</span><span class="p">(</span><span class="n">run</span><span class="p">).</span><span class="n">location</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span> <span class="n">lineOrigin</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">runDescent</span><span class="p">,</span> <span class="n">runRect</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">runAscent</span> <span class="o">+</span> <span class="n">runDescent</span><span class="p">);</span>
            
            <span class="n">NSString</span> <span class="o">*</span><span class="n">imageName</span> <span class="o">=</span> <span class="p">[</span><span class="n">attributes</span> <span class="n">objectForKey</span><span class="o">:</span><span class="s">@&quot;imageName&quot;</span><span class="p">];</span>
            <span class="c1">//图片渲染逻辑</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">imageName</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">UIImage</span> <span class="o">*</span><span class="n">image</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIImage</span> <span class="n">imageNamed</span><span class="o">:</span><span class="n">imageName</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">image</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">CGRect</span> <span class="n">imageDrawRect</span><span class="p">;</span>
                    <span class="n">imageDrawRect</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
                    <span class="n">imageDrawRect</span><span class="p">.</span><span class="n">origin</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">runRect</span><span class="p">.</span><span class="n">origin</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">lineOrigin</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
                    <span class="n">imageDrawRect</span><span class="p">.</span><span class="n">origin</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">lineOrigin</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
                    <span class="n">CGContextDrawImage</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">imageDrawRect</span><span class="p">,</span> <span class="n">image</span><span class="p">.</span><span class="n">CGImage</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="n">CFRelease</span><span class="p">(</span><span class="n">ctFrame</span><span class="p">);</span>
    <span class="n">CFRelease</span><span class="p">(</span><span class="n">path</span><span class="p">);</span>
    <span class="n">CFRelease</span><span class="p">(</span><span class="n">ctFramesetter</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>




</section>
<section class="meta">
<span class="author">
  <a href="http://geeklu.com">海涛</a>
</span>
<span class="time">
  /
  <time datetime="2013-03-11">2013-03-11</time>
</span>
<br />
<span class="license">
  Published under <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">(CC) BY-NC-SA</a>
</span>

<span class="categories">
  in categories
  
  <a href="/categories/#programming" title="programming">programming</a>&nbsp;
  
</span>


<span class="tags">
  tagged with 
  
  <a href="/tags/#Mac" title="Mac">Mac</a>&nbsp;
  
  <a href="/tags/#iOS" title="iOS">iOS</a>&nbsp;
  
</span>

</section>
<section class="comment">
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'geeklu'; // required: replace example with your forum shortname
    var disqus_url = '/2013/03/core-text/';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</section>


<script type="text/javascript">
$(function(){
  $(document).keydown(function(e) {
    var url = false;
        if (e.which == 37 || e.which == 74) {  // Left arrow and J
            
        }
        else if (e.which == 39 || e.which == 75) {  // Right arrow and K
            
        url = '/2013/03/seek-differences/';
        
        }
        if (url) {
            window.location = url;
        }
  });
})
</script>


        </article>
      </div>

    <footer>
        <p><small>Powered by <a href="https://github.com/mojombo/jekyll">Jekyll</a> | Copyright 2008 - 2013 by <a href="http://geeklu.com/about/">Luke</a> | <span class="label label-info">2013-08-29 18:43:02 CST</span></small></p>
    </footer>

    </div>

    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-12936429-2']);
      _gaq.push(['_trackPageview']);
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </body>
</html>
